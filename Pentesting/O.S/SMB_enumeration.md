<p align="center">
  <a href="https://github.com/DenverCoder1/readme-typing-svg"><img src="https://readme-typing-svg.herokuapp.com?font=Fira+Code&size=19&pause=1000&color=D1F700&width=579&lines=Enumerar+recursos+de+SMB+con+SMBMAP+y+SMBCLIENT"></a>
</p>

<h1 align="center"></h1>

<h3 align="center"><ins>¿Qué es el Protocolo SMB (445)?</ins></h3>

SMB (Server Message Block) es un protocolo de red que permite a aplicaciones y usuarios compartir archivos, discos, directorios, impresoras, puertos seriales y mail slots a través de una red, predominantemente en sistemas operativos Microsoft Windows. SMB sigue una estructura cliente-servidor, donde el cliente realiza una solicitud y el servidor responde. Básicamente, SMB permite a un cliente leer, crear y modificar archivos en un servidor remoto, facilitando la comunicación con cualquier servidor configurado para aceptar solicitudes SMB.

Además, existe Samba, una implementación libre del protocolo SMB con las extensiones específicas de Microsoft. Samba funciona en sistemas operativos GNU/Linux y otros UNIX, proporcionando compatibilidad y funcionalidad similar a la de SMB en entornos Windows. Como cualquier protocolo de intercambio de archivos en red, SMB necesita puertos de red para comunicarse con otros sistemas. Originalmente, utilizaba el puerto 139, que permitía la comunicación entre computadoras en la misma red local. Sin embargo, desde Windows 2000, SMB utiliza el puerto 445 y el protocolo de red TCP para establecer comunicación con otras computadoras, incluso a través de Internet.

<p align="center">
  <img src="https://raw.githubusercontent.com/R3LI4NT/articulos/main/Pentesting/O.S/img/SMB_enumeracion.png">
</p>

<h1 align="center"></h1>

Para este ejemplo voy a utilizar la máquina <a href="https://tryhackme.com/room/kenobi">Kenobi</a> de TryHackMe y también la de <a href="https://github.com/R3LI4NT/ctf-retos/blob/main/1-%20Maquinas-Easy/Metasploitable_2.md">Metasploitable 2</a>.

### RECOPILAR y ENUMERAR RECURSOS | SMBMAP & SMBCLIENT

- SMBMAP es una útil herramienta pensada en la post-explotación de un sistema, es decir, cuando ya se consigue el usuario y contraseña. Permite enumerar los recursos compartidos de un servicio SMB/Samba para así ver el contenido, los permisos, subir y descargar archivos, hasta la ejecución de comandos. Esta herramienta viene por defecto en Kali Linux.

**_Instalar en Debian:_**
```
sudo apt-get install smbmap
```

Para hacer un escaneo predeterminado simplemente ingresamos la IP de destino de esta manera:
```
smbmap -H 10.10.241.119
```

![1](https://github.com/R3LI4NT/articulos/assets/75953873/2a0382fb-21f0-4d3e-b4a3-a9b22d58760f)


Podemos ver que `anonymous` tiene acceso de lectura. En el siguiente ejemplo, veamos cómo enumerar el directorio `anonymous` con el parámetro `-r`.
```
smbmap -H 10.10.241.119 -r anonymous
```

![2](https://github.com/R3LI4NT/articulos/assets/75953873/fd92a269-6aa1-4570-991b-97af737fb8fd)

Nos muestra que el archivo `log.txt` tiene permiso de lectura (-r = read).  Esta herramienta se utiliza en dos fases: una durante la recolección de información y la otra en la post-explotación. En el ejemplo anterior se utiliza antes de la explotación (recopilar información), ahora veamos para enumerar recursos de samba en la post-explotación (cuando ya se tiene las credenciales del objetivo).
```
smbmap -H 192.168.25.130 -u msfadmin -p msfadmin
```

## Uso:
| COMANDO | DESCRIPCION |
| ------------- | ------------- |
| -H | Dirección IP de destino  |
| -u  | Usuario  |
| -p  | Contraseña  |

![2-1](https://github.com/R3LI4NT/articulos/assets/75953873/90aca9b7-fcf3-47c2-a70a-fa4099fcc347)

- SMBCLIENT es otra alternativa que permite acceder a los recursos compartidos de un servidor SMB, se usa principalmente para subir y descargar archivos; sus comandos comparten similitudes a una conexión FTP.

- **_Instalar en Debian:_**
```
sudo apt-get install smbclient
```

Para acceder a los recursos compartidos se debe ejecutar lo siguiente:
```
smbclient //10.10.241.119/anonymous -N
```

## Uso:
| COMANDO | DESCRIPCION |
| ------------- | ------------- |
| -N | Sesión de tipo NULL, sin credenciales  |

![3](https://github.com/R3LI4NT/articulos/assets/75953873/c45cd946-e3d3-4cff-a6d1-cc588b39d399)

Con credenciales:
```
smbclient //192.168.25.130/tmp --password=msfadmin
```

![3-1](https://github.com/R3LI4NT/articulos/assets/75953873/bbde8e81-b0f6-4477-850e-6c90238cc54c)

Ahora, una vez dentro veamos como descargar un archivo, en mi caso el `log.txt`.
```
get log.txt
```

![4](https://github.com/R3LI4NT/articulos/assets/75953873/916f4028-3e62-42fa-ab71-41b35b1da292)

Obtener información del archivo:
```
allinfo log.txt
```

![5](https://github.com/R3LI4NT/articulos/assets/75953873/13fc6e85-9c3a-4fb6-92eb-6a3c981162b2)

Y como ven, desde la máquina local he descargado el archivo para una mejor inspección.

![6](https://github.com/R3LI4NT/articulos/assets/75953873/9857e564-f63f-4713-bcd2-b57eb84e9bc7)


<h1 align="center"></h1>

</br>

#### RIESGO A TOMAR EN CUENTA

Tener el protocolo SMB abierto puede permitir a un atacante remoto obtener información confidencial de los sistemas afectados mediante recursos compartidos como se observan en los ejemplos. Una de las vulnerabilidades más famosas fue la de <a href="https://github.com/R3LI4NT/articulos/blob/main/Pentesting/O.S/eternalblue.md">EternalBlue</a>, utilizada por el ransomware WannaCry en el año 2017, y también en la vulnerabilidad SMBGhost que permitió ejecutar comando remoto.

Como acción recomendada, deshabilita el puerto 445 desde el firewall de Windows a menos que se necesite por algún servicio. Para ello se deben ir a la configuración de `Firewall de Windows Defender` **>** `Configuración avanzada`.

![8](https://github.com/R3LI4NT/articulos/assets/75953873/f819939f-3ea8-46d4-97d1-ae58d93f54fd)

Luego a `Reglas de Salida` **>** `Nueva regla`.

![9](https://github.com/R3LI4NT/articulos/assets/75953873/2355c8cf-3968-4997-90b9-b3b61330bcf4)

Seleccionan puerto y le dan a siguiente.

![10](https://github.com/R3LI4NT/articulos/assets/75953873/2da2e41b-9e99-49b9-b2a9-ae22bd57d289)

Escriben el número del puerto (445 y/o 139) y le dan a siguiente.

![11](https://github.com/R3LI4NT/articulos/assets/75953873/09e1c235-6244-41ef-b640-388ca34b8d48)

Bloquean la conexión del puerto.

![12](https://github.com/R3LI4NT/articulos/assets/75953873/9b7c75bb-f0a3-46bc-a64f-820e03d9d935)

Activan las tres casillas.

![13](https://github.com/R3LI4NT/articulos/assets/75953873/ca60adb0-1030-47de-8206-bbd33fb6dd9e)

Y por último le dan un nombre a la regla para que sea fácil identificarla y así poder modificarla cuando se requiera.

![14](https://github.com/R3LI4NT/articulos/assets/75953873/11e5035a-113d-4a0d-bbba-089097ab4696)

Y con esto ya bastaría, recuerda que para volver a usar el protocolo deben deshabilitar la regla o permitir la conexión desde propiedades,

![15](https://github.com/R3LI4NT/articulos/assets/75953873/9f36e7c8-f7c5-44cb-b97a-89f11b1984c9)

</br>

<h1 align="center"></h1>

<h3 align="center"><ins>ADVERTENCIA<ins></h3>

<h4 align="center">Esto es con fines de aprendizaje, no nos hacemos responsables ni el fundador, ni el creador del tema del mal uso de esta herramienta u información.</h4>



#### ~R3LI4NT~
