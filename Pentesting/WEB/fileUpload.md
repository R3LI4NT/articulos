<p align="center">
  <a href="https://github.com/DenverCoder1/readme-typing-svg"><img src="https://readme-typing-svg.herokuapp.com?font=Fira+Code&pause=1000&color=D1F700&width=430&lines=Explotar+vulnerabilidad+File+Upload"></a>
</p>

<h1 align="center"></h1>

<h3 align="center"><ins>VULNERABILIDAD FILE UPLOAD</ins></h3>

Es un tipo de vulnerabilidad que ocurre en aplicaciones web en donde existe la posibilidad de subir un archivo sin que sea comprobado por un sistema de seguridad; por ejemplo, una web shell en **.php** y ser ejecutada en el mismo servidor.

#### PELIGROS
El atacante una vez que haya ganado acceso al servidor puede colocar una página de phishing en el sitio web o incrustar malware, así como también puede ser capaz de causar un ataque de Denegación de Servicio (DoS) al subir archivos de gran tamaño.

### ¿Qué es un 'Reverse Shell'?

Una reverse shell, también conocida como shell inversa, es una especie de "servidor" en donde el atacante ejecuta un software que queda a escucha de solicitudes de conexiones en un determinado puerto, la máquina objetivo se conecta al servidor y entonces es así como el atacante gana una shell para ejecutar comandos remotamente (sin interfaz gráfica).

<p align="center">
  <img src="https://github.com/R3LI4NT/articulos/blob/main/Pentesting/WEB/img/reverse_shell.png">
</p>

`Atacante`: Inicia un servidor a escucha en el puerto 4444.

`Víctima`: Se conecta al servidor.

`Atacante`: Obtiene una shell remota de la máquina víctima.

</br>

### Método GET y POST HTTP

El protocolo HTTP es utilizado para conectar un cliente a un servidor a través de métodos de petición para ejecutar la acción que se desea realizar. 

Método **GET**: Se utiliza para pedir información al servidor, los datos son enviados de forma visible en la URL.

Por ejemplo:
```
http://www.myweb./action.php?nombre=wilson&apellidos1=smith
```

El atacante lo que hace aquí es interceptar la petición HTTP y luego la modifica para cambiar la extensión del archivo.

Método **POST**: Se utiliza para subir un archivo o loguearse en el sitio web, los datos son enviados de forma codificada (no visible); siendo está la más segura.

<p align="center">
  <img src="https://github.com/R3LI4NT/articulos/blob/main/Pentesting/WEB/img/solicitudesHTTP.png">
</p>

<h1 align="center"></h1>

### WEEVELY

Weevely es una herramienta de administración de webshell escrita en python, sirve para crear backdoors en .PHP y contiene más de 30 módulos para testear tareas administrativas; mantener acceso, elevar privilegios y difundirse en la red. Cabe recalcar que un <a href="https://www.iberianpress.es/noticia/que-es-un-black-hat-hacker/16939">black hat</a> podría utilizar esta vulnerabilidad para obtener acceso de administrador y desconfigurar la web, ya sea borrar la base de datos como un defacement.

**Instalar herramienta en Debian:**
```
sudo apt-get install weevely
```

A continuación, haré uso de la máquina <a href="https://github.com/R3LI4NT/ctf-retos/blob/main/1-%20Maquinas-Easy/Metasploitable_2.md">Metasploitable2</a>, ya que viene incorporada con vulnerabilidades para explotar en un entorno controlado y legal.

![1](https://user-images.githubusercontent.com/75953873/185830982-5503ea26-6de1-4f70-bc04-302307fc9cf8.png)

**Servidor local**: `http://192.168.25.128/dvwa/login.php`

<a href="https://github.com/digininja/DVWA">DVWA</a> (Damn Vulnerable Web Application) es una aplicación web PHP/MySQL vulnerable. Su objetivo es ayudar a los profesionales de seguridad a probar sus habilidades y herramientas en un entorno controlado y legal.

Debajo se encuentran las credenciales.

Usuario: `admin`

Contraseña: `password`

![2](https://user-images.githubusercontent.com/75953873/185831672-11c95a51-51a4-4019-bf77-a0293bad921b.png)

Si nos dirigimos a seguridad de DVWA, podemos establecer el nivel del mismo, escogeré el nivel bajo para obtener acceso solamente usando weevely.

![3](https://user-images.githubusercontent.com/75953873/185831871-43dd7482-0343-4921-8646-e56835108a76.png)

Lo siguiente es abrir una nueva terminal y crear la puerta trasera (backdoor) con weevely que nos dará acceso al servidor:
```
weevely generate <contraseña_de_nuestro_backdoor> <nombre.php>
```
![4](https://user-images.githubusercontent.com/75953873/185832246-1a337577-47dc-4c88-9cb8-590cd3773615.png)

Regresamos a la aplicación web e iremos a donde dice "**Upload**" y subimos nuestro backdoor generado.

![5](https://user-images.githubusercontent.com/75953873/185832425-20a9d4a2-0481-4e51-a222-e498a7c0c254.png)

El backdoor ha sido subido exitosamente. Devuelve una ruta el cual debemos de copiar y unirla con la URL del servidor, quedaría de la siguiente forma:
```
http://192.168.25.128/dvwa/hackable/uploads/backdoor.php
```

Nuevamente nos dirigimos a la terminal y ejecutamos el siguiente comando:
```
weevely <URL> <contraseña_del_backdoor>
```

Esto nos dará acceso remoto al servidor:

![6](https://user-images.githubusercontent.com/75953873/185832992-e034ee48-7036-4747-a940-2f8ae6c1e433.png)

![7](https://user-images.githubusercontent.com/75953873/185832997-897a0ccf-fc88-4727-9943-0195a9a8d8eb.png)

<h1 align="center"></h1>

Si quisieramos hacerlo manual, Kali trae consigo una colección de webshells en el directorio `/usr/share/webshells/` a utilizar. En este caso, se hará uso de una reverse shell en PHP.
```
cp /usr/share/webshells/php/php-reverse-shell.php .
```
![8](https://user-images.githubusercontent.com/75953873/186302330-17ca1fee-5286-476b-9192-68080d15413a.png)

Luego editamos el código con un IDE, por ejemplo nano o vim. En la variable `$ip` introducimos la IP local de nuestra máquina atacante y en la variable `$port` el puerto escucha; que puede ser cualquiera.

![9](https://user-images.githubusercontent.com/75953873/186302769-eabcb631-fb41-40b1-8d84-66d0901259fd.png)

Subimos nuestra reverse shell y copiamos la URL **->** `http://192.168.25.128/dvwa/hackable/uploads/php-reverse-shell.php`

![10](https://user-images.githubusercontent.com/75953873/186302990-4e6d3612-34c4-4d65-a866-e4ed0cf46792.png)

Abrimos una nueva terminal y ponemos a escucha el puerto `4444` con Netcat:
```
nc -lvp 4444
```
![11](https://user-images.githubusercontent.com/75953873/186303114-5afd9649-58c3-4b2a-b6de-635c841e77ca.png)

Recargamos la URL que copiamos y al regresar a la terminal ya tendremos acceso al servidor:

![12](https://user-images.githubusercontent.com/75953873/186303348-b36578c6-c4ae-4a4b-9a34-13be38e2abc7.png)

<h1 align="center"></h1>

### WEEVELY + BURP SUITE

Burp Suite es una poderosa herramienta escrita en Java que permite realizar pruebas de seguridad de aplicaciones web, cuenta con una versión gratuita y de paga. Su función básica se encuentra en el servidor proxy que permite interceptar el tráfico entre el navegador y aplicación destino, el cual posibilita inspeccionarlo y modificarlo.

Es compatible con diversos sistemas operativos como Windows, GNU/Linux, Mac: https://portswigger.net/burp/communitydownload

Tutoriales de Burp Suite desde cero: https://www.manusoft.es/tutorial-burp-suite/

Esta vez subiré la seguridad del servidor DVWA a medio. Lo siguiente será configurar un servidor proxy para que registre todo el tráfico que se genere en el navegador web, para ello debemos ejecutar Burp Suite e ir a la pestaña de *Proxy* **->** *Options* y verificar si tenemos el proxy como se muestra a continuación:

![13](https://user-images.githubusercontent.com/75953873/186309125-51ad97c3-b823-4825-8bc4-43fb74091e88.png)

Luego en el navegador, por ejemplo Firefox ir a *Preferencias* **->** *Avanzadas* **->** *Proxy de Red* **->** *Configuración* **->** *Configuración Manual del Proxy*

En **Proxy HTTP** escribir `127.0.0.1`, en **Puerto** escribir `8080` y tildar el mismo proxy para todo:

![14](https://user-images.githubusercontent.com/75953873/186309874-aa443078-e385-45dd-bbb0-faca9508e320.png)

En Burp Suite debemos verificar en la pestaña *Proxy* **->** Intercept que esté en **Intercept is on**:

![15](https://user-images.githubusercontent.com/75953873/186309969-a564204b-a5f9-4a65-9e3f-425b3c3e77fa.png)

Cuando comenzamos hacer peticiones en el navegador, como por ejemplo ir a una página web, Burp Suite debe Interceptar la petición y allí podemos modificarla. Si volvemos a subir el mismo backdoor nos tirará un error porque al aumentar la seguridad solo nos permite subir un archivo con extensión .jpg.

![16](https://user-images.githubusercontent.com/75953873/186310292-8f3a483b-1c04-4996-8d74-87aa31ec0d48.png)

Al backdoor.php lo renombramos a **.jpg** y volvemos a subirlo:

![17](https://user-images.githubusercontent.com/75953873/186310656-c3b5cd4e-aa59-4c1b-9539-39fbc8bfe923.png)

La petición ha sido interceptada, ahora solo quedaría con renombrar el backdoor (línea 20) a **.php** desde Burp Suite:

![18](https://user-images.githubusercontent.com/75953873/186310857-1e4fec9a-fa33-4969-898f-e0477488bb1e.png)

Dáremos en **Forward** para redireccionar la petición al servidor y que esté la procesé:

![19](https://user-images.githubusercontent.com/75953873/186311160-e58c97e0-6d22-4fdb-a65b-f1b7a751208f.png)

Seguidamente, repetimos los pasos en nuestra shell con weevely:
```
weevely <URL> <contraseña_del_backdoor>
```
![20](https://user-images.githubusercontent.com/75953873/186311550-0138d5e7-1c66-48cd-bfb0-7a4898dc935f.png)

Por último, aumenté la seguridad a alta y lo único que tengo que hacer es renombrar el backdoor.jpg a **backdoor.php.jpg** y volver a subirlo:

![21](https://user-images.githubusercontent.com/75953873/186311935-6c8d792c-d6ff-4a23-8be3-3449be4f1e10.png)

![22](https://user-images.githubusercontent.com/75953873/186312166-b749bc87-b787-4ca8-8e47-a9133a5c9850.png)

Al presionar nuevamente a **Forward** el archivo se subió exitosamente, por lo cual podemos repetir los mismos pasos anteriores para obtener el acceso solamente que la URL iría hasta **.php** y no **.jpg**.

![23](https://user-images.githubusercontent.com/75953873/186312387-43d22cf9-7504-4dff-affc-2a6173a0c05d.png)

![24](https://user-images.githubusercontent.com/75953873/186313829-a4973f8f-98b1-4fa7-b490-e0354c0b3361.png)

<h1 align="center"></h1>

</br>

Es una vulnerabilidad muy peligrosa que permite a un atacante apropiarse de una página web por medio de un reverse shell o puerta trasera. Como seguridad recomiendo que nunca permitan que los usuarios puedan subir arhivos ejecutables (.php, .exe, .bat, etc), analizar el archivo y la extensión.



#### ~R3LI4NT~
