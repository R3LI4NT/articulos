<p align="center">
  <a href="https://github.com/DenverCoder1/readme-typing-svg"><img src="https://readme-typing-svg.herokuapp.com?font=Fira+Code&pause=1000&color=D1F700&width=700&lines=Ataque+de+Directorio+Transversal+%2F+Path+Traversal"></a>
</p>

<h1 align="center"></h1>

<h3 align="center"><ins>VULNERABILIDAD de DIRECTORIO TRANSVERSAL</ins></h3>

El reccorrido de directorio (también conocido como cruce de rutas de archivos) es una vulnerabilidad de seguridad web que permite a un atacante leer archivos arbitrarios en el servidor que ejecuta una aplicación. Es una vulnerabilidad crítica que permite a un atacante apropiarse de archivos confidenciales del sistema operativo, incluir código y datos de la aplicación, escribir archivos arbitrarios que le permita modificar los datos de la aplicación y obtener control total del servidor.

Mediante la manipulación de variables que hacen referencia a archivos con secuencia "**punto-punto-barra**" (`../`) y sus variaciones, es posible acceder a archivos y directorios que se almacenan fuera de la carpeta raíz web, incluido el código fuente o la configuración de la aplicación. Cabe mencionar que el acceso a ciertos archivos está limitado por los privilegios de acceso del sistema operativo. Existe la posibilidad que un atacante pueda incluir un archivo o recurso remoto que usted no autorizó (scripts, temas, imágenes, recursos locales, etc).

<p align="center">
  <img src="https://github.com/R3LI4NT/articulos/blob/main/Pentesting/WEB/img/pathTraversal.png">
</p>

- <a href="https://owasp.org/www-community/attacks/Path_Traversal">Path Traversal - OWASP</a>

</br>

#### Ejemplo de PATH TRAVERSAL:

Una vulnerabilidad de salto de directorios consiste en construir la ruta de descarga de un fichero mediante el campo `input` ingresado por el usuario. La falta de validación del `input` es la clave para poder ser explotada y adueñarse de información sensible nombrada anteriormente. Cuando la dirección URL de un subdirectorio de un sitio web se ve de la siguiente forma, posiblemente sea vulnerable a un path traversal:

```
https://website.com/?file=filename.php
```

### Vectores de ATAQUE:

Para acceder a ficheros o ejecutar comandos en cualquier parte del sistema un atacante hará uso de secuencias de caracteres especiales, comúnmente como se menciono antes "**punto-punto-barra**" (`../`). Esto permitiría que el atacante comprometa el sistema y pueda navegar por toda la estructura de directorios de este, ganando acceso a ficheros del sistema, código fuente, entre otras. Los ataques de directorio transversal suelen ir acompañados de otras vulnerabilidades como <a href="https://github.com/R3LI4NT/articulos/blob/main/Pentesting/WEB/LocalFileInclusion.md">**Local File Inclusion (LFI)**</a> y/o **Remote File Inclusion (RFI)**.

Para identificar que parte de las aplicaciones son vulnerables, el atacante necesita comprobar todas las vías que acepten datos del usuario. Estas vías abarcan consultas GET, POST, HTTP y hasta formularios de subidas de ficheros. En el siguiente ejemplo se observa un código inseguro PHP, la secuencia de comandos pasa un valor de solicitud HTTP no desinfectado directamente a la función de `PHP include()`. El script intentará incluir cualquier ruta/nombre de archivo que se pase como parámetro.

```php
$index = $_GET['index'];
include($index);
```
Por ejemplo, si pasa `/etc/passwd` como argumento, este archivo es legible para todos los usuarios. Por lo tanto, el script devuelve el contenido del archivo con información sobre todos los usuarios del sistema:

![1](https://user-images.githubusercontent.com/75953873/214969908-46be5843-ae97-44b6-9d29-f5de686fc78c.png)

- **/etc/passwd**: decargar el fichero `«passwd»` con las contraseñas del sistema.

Sin embargo, la manera más fácil de mitigar esta vulnerabilidad es usar las funciones `basename()` y `realpath()`. La función `basename()` devuelve solo la parte del nombre de archivo de una ruta/nombre de archivo dado: `basename("../../../etc/passwd")` = **passwd**. La función `realpath()` devuelve la ruta de acceso absoluta canonicalizada, pero solo si el archivo existe y si el script en ejecución tiene permisos de ejecución en todos los directorios de la jerarquía: `realpath("../../../etc/passwd")` = **/etc/contraseña**. El código quedaría de la siguiente forma:

```php
$index = basename(realpath($_GET['index']));;
include($index);
```

### PAYLOADS - EXPLOTACIÓN

Para conseguir explotar esta vulnerabilidad con éxito, es preciso conocer la arquitectura del sistema operativo que alberga la aplicación web. El atacante necesita hacer filtros impuestos por el usuario para evitar la carga de ficheros restringido (evitar usar `../` o **byte nulo**). La manipulación de variables permite eludir el filtrado de entrada mal implementado. Para ello podemos utilizar la codificación URL-Encode:

|  | URL | URL Doble | Unicódigo UTF-8 | Unicode de 16 bits |
| ------------- | ------------- | ------------- | ------------- | ------------- |
| . | %2e | %252e | %c0%2e %e0%40%ae %c0%ae | %u002e |
| / | %2f | %252f | %c0%2f %e0%80%af %c0%af | %u2215 |
| \ | %2c |%252c | %c0%5c %c0%80%5c | %u2216 |
| ../ | %2e%2e%2f | %252e%252e%252f | %c0%ae%c0%ae%c0%af | %uff0e%uff0e%u2215 |
| ..\ | %2e%2e%2c | %252e%252e%252c | %c0%ae%c0%ae%c0%af | %uff0e%uff0e%u2216 |

- **%2e%2e%2f** representa **->** `../`: moverse de manera ascendente entre los directorios.

Los ataques inteligentes son los que encuentran formas de eludir las restricciones para la entrada proporcionada por el usuario. Por ejemplo:

- **../../../etc/** se puede escribir **->** `..%2f..%2f..%2fetc%2f`.

<h1 align="center"></h1>

</br>

### EJEMPLO DE EXPLOTACIÓN MANUAL | Metasploitable2

A continuación, mostraré como es posible identificar y aprovecharse de la vulnerabilidad Path Traversal. Cabe recalcar que estoy ejecutando un entorno controlable y vulnerable llamado <a href="https://github.com/R3LI4NT/ctf-retos/blob/main/1-%20Maquinas-Easy/Metasploitable_2.md">**Metasploitable2**</a> para llevar a cabo el procedimiento. Con la dirección IP de la máquina podremos acceder al servicio web a través del navegador.

![2](https://user-images.githubusercontent.com/75953873/215303695-ed98b86a-2b92-476a-b5bb-ebe6741c3b13.png)

Si observamos detalladamente la URL, es posible retroceder por los directorios luego de la variable `?page=`.

![3](https://user-images.githubusercontent.com/75953873/215303809-306f91e6-2070-453a-9b18-214a1a360020.png)

Con el parámetro de slash "`/`" **+** dos puntos "`..`" recorremos los directorios infinitamente, logrando así acceder a los archivos del servidor web.

![4](https://user-images.githubusercontent.com/75953873/215304005-92380f4c-96e0-42bf-86fd-6f672d098da5.png)

Dentro de la máquina víctima he creado un fichero de texto llamado `filename.txt` y dentro escribí el mensaje "`Hello, Friend`", lo guarde en el directorio "`/home/`". Utilizaré nuevamente los caracteres especiales para recorrer entre los directorios y encontrar el fichero oculto.

![5](https://user-images.githubusercontent.com/75953873/215304292-53a8b83b-e72e-4dd3-817f-f2aad361a6d1.png)

Efectivamente, el fichero es legible y nos muestra el contenido.

![6](https://user-images.githubusercontent.com/75953873/215304353-dda14123-32a2-460e-874c-60c5e85c74bc.png)

Ahora probemos que pasaría si aumentamos el nivel de seguridad y volviéramos a intentarlo.

![7](https://user-images.githubusercontent.com/75953873/215304665-4d26179f-1317-4779-9412-1f034e8a2120.png)

En la captura anterior se puede ver que ya no es posible acceder a los directorios, aquí es donde tendremos que hacer uso de los payloads codificados que se vieron anteriormente. Por ejemplo, el payload `%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd` equivale a "`../../../../etc/passwd`".

![8](https://user-images.githubusercontent.com/75953873/215304680-02ccdbcb-1ff8-434e-833d-9015f4a82e46.png)

Con la herramienta de pentesting web Burp Suit podemos configurar un proxy y capturar la petición antes de ser enviada, para posteriormente modificarla y reenviarla.

![9](https://user-images.githubusercontent.com/75953873/215305103-3a2572cf-422b-4f6d-a5fb-ea6e10a30fd0.png)
